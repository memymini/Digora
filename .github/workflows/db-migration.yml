name: Supabase Production DB Migration

on:
  push:
    branches:
      - main # main ë¸Œëœì¹˜ì— ì½”ë“œê°€ í‘¸ì‹œë  ë•Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰

jobs:
  migrate_db:
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Set up Supabase CLI
        # Supabase CLIë¥¼ ì„¤ì¹˜í•˜ê³  PATHì— ì¶”ê°€
        uses: supabase/setup-cli@v1

      - name: ğŸ”— Link Project (Optional, for context)
        # Production í”„ë¡œì íŠ¸ ì°¸ì¡° IDë¥¼ ì‚¬ìš©í•˜ì—¬ CLI ì»¨í…ìŠ¤íŠ¸ ì„¤ì •
        run: supabase link --project-ref ${{ secrets.PROD_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: ğŸš€ Apply Migrations to Production DB
        id: db_push
        run: |
          # Gitì— ì»¤ë°‹ëœ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ë“¤ì„ Production DBì— ì ìš©
          # --linked: linkëœ í”„ë¡œì íŠ¸ì˜ ë§ˆì´ê·¸ë ˆì´ì…˜ ê¸°ë¡ì„ ì‚¬ìš© (Test/Dev)
          # --remote-db-url: ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì ìš©í•  ì›ê²© Production DB ì§€ì •
          supabase db push --linked --remote-db-url $PROD_DB_URL
        env:
          # GitHub Secretsì— ì €ì¥ëœ Production DB URL ì‚¬ìš©
          PROD_DB_URL: ${{ secrets.PROD_DB_URL }}
          # CLI ì¸ì¦ì„ ìœ„í•œ Supabase Access Token (í•„ìš” ì‹œ)
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: âœ… Check Migration Status
        if: always()
        run: |
          # ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© í›„ ìƒíƒœë¥¼ í™•ì¸í•˜ì—¬ ì„±ê³µ ì—¬ë¶€ ë¡œê·¸
          # ì‹¤íŒ¨ ì‹œ ì˜¤ë¥˜ ë¡œê·¸ í™•ì¸
          echo "Migration process finished. Check logs for success/failure."
